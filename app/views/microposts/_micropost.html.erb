<% unless defined? parent %>
  <li id="micropost-<%= micropost.id %>">
<% else %>
  <div class="parent_micropost">
<% end %>
    <% unless current_user.following?(micropost.user) or
              current_user == micropost.user or
              defined? parent %>
        <%= micropost.followings_who_reposted(current_user).first.name %>
        <%= (micropost.followings_who_reposted(current_user).count > 1 ? 'and others' : '') %>
        reposted this<br><br>
    <% end %>
    <%= link_to gravatar_for(micropost.user, size: 50), micropost.user %>
    <span class="user"><%= link_to micropost.user.name, micropost.user %></span>
    <span class="content">
      <%= micropost.content %>
      <%= image_tag micropost.display_image if micropost.image.attached? %>
      <% unless micropost.parent_id.nil? %>
        <%= render 'microposts/parent', micropost: micropost %>
      <% end %>
    </span>
    <span class="timestamp">
      Posted <%= time_ago_in_words(micropost.created_at) %> ago.
      <span id="repost_count-<%= micropost.id %>">
        <%= pluralize(micropost.rqcount, 'repost') %>
      </span>
      <span id="comment_count-<%= micropost.id %>">
        <%= pluralize(micropost.comments.count, 'comment') %>
      </span>
      <%= link_to "Quote", quote_micropost_path(id: micropost.id) if logged_in? %>
      <%= render 'microposts/repost_form', micropost: micropost if logged_in? %>
      <%= link_to "Comment", micropost if logged_in? %>
      <% if current_user?(micropost.user) %>
        <%= link_to "delete", micropost, method: :delete,
                                         data: { confirm: "You sure?" } %>
      <% end %>
    </span>
<% unless defined? parent %>
  </li>
<% else %>
  </div>
<% end %>